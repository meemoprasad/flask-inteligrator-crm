<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Onboarded Customers</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<nav class="navbar">
    <div class="navbar-links"> {# Added wrapper div #}
        <a href="/dashboard">Dashboard</a>
        {% if 'customer_management' in session.get('page_access', []) or session.get('role') == 'admin' %}
             <a href="/customer_management">Customer Management</a>
        {% endif %}
        {% if 'onboarded_customers' in session.get('page_access', []) or session.get('role') == 'admin' %}
            <a href="/onboarded_customers" class="font-bold">Onboarded Customers</a> {# Kept font-bold for emphasis #}
        {% endif %}
        {% if session.get('role') == 'admin' %}
            <a href="/user_management">User Management</a>
        {% endif %}
    </div>
     <div class="welcome-info"> {# Added wrapper div #}
        <span>Welcome, {{ session.get('username', 'Guest') }}!</span>
        <a href="/logout">Logout</a>
    </div>
</nav>

<div class="container"> {# Using container class #}
    <div class="list-container"> {# Using list-container class #}
        <h1 class="page-title">Onboarded Customers</h1> {# Changed to h1 and added class #}

         {% with messages = get_flashed_messages() %}
            {% if messages %}
                <ul class="flash-messages"> {# Use flash-messages class #}
                {% for message in messages %}
                    <li class="error">{{ message }}</li> {# Use error class for messages #}
                {% endfor %}
            </ul>
            {% endif %}
        {% endwith %}

        <div class="table-wrapper"> {# Added table-wrapper for overflow #}
            <table>
                <thead>
                    <tr>
                        <th>ID</th> {# Changed from Customer ID #}
                        <th>Customer ID</th>
                        <th>Name</th>
                        <th>Company</th>
                        <th>City</th>
                        <th>State</th>
                        <th>Country</th>
                        <th>Industry</th>
                        <th>Onboarding Date</th>
                        <th>Set Reminder</th>
                        <th>Reminder Info</th>
                        <th>Follow-up Status</th>
                        <th>New Follow-up Remark</th>
                    </tr>
                </thead>
                <tbody>
                {% for c in customers %}
                <tr>
                    <td>{{ c[0] }}</td> {# rowid #}
                    <td>{{ c[2] }}</td> {# customer_id - Corrected Index #}
                    <td>{{ c[3] }}</td> {# name - Corrected Index #}
                    <td>{{ c[4] }}</td> {# company - Corrected Index #}
                    <td>{{ c[6] }}</td> {# city - Corrected Index #}
                    <td>{{ c[7] }}</td> {# state - Corrected Index #}
                    <td>{{ c[8] }}</td> {# country - Corrected Index #}
                    <td>{{ c[9] }}</td> {# industry - Corrected Index #}
                    <td>{{ c[13] }}</td> {# onboarding_date - Corrected Index #}

                    <td>
                        <button onclick="openReminderModal({{ c[0] }})" class="action-button"> {# Added class #}
                            Set Reminder
                        </button>
                    </td>

                    <td>
                        {% for r in reminders %}
                            {# r[1] is customer_id in reminders table (should be rowid of customer) #}
                            {% if r[1] == c[0] %}
                                <div class="onboarded-customer-info"> {# Added class #}
                                    üìÖ <b>{{ r[2] }}</b><br> {# reminder_datetime #}
                                    üìù {{ r[3] }} {# message #}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </td>

                    <td>
                        {% set count = 1 %}
                        {% for f in followups %}
                             {# f[1] is customer_id in followups table (should be rowid of customer) #}
                            {% if f[1] == c[0] %}
                                <div class="onboarded-customer-info"> {# Added class #}
                                    {{ count }}. {{ f[2] }} <br> {# remark #}
                                    <span class="timestamp">{{ f[3] }}</span> {# Added class #}
                                </div>
                                {% set count = count + 1 %}
                            {% endif %}
                        {% endfor %}
                    </td>

                    <td class="onboarded-customer-actions"> {# Added class #}
                        <form action="/add_followup/{{ c[0] }}" method="POST"> {# Use rowid for the route #}
                            <textarea name="followup_text" maxlength="400" required placeholder="Write follow-up (max 400 chars)"></textarea>
                            <button type="submit">
                                Submit
                            </button>
                        </form>
                    </td>

                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="reminderModal" class="modal"> {# Using modal class #}
    <div class="modal-content"> {# Using modal-content class #}
        <h2>Set Reminder</h2>
        <form id="reminderForm" method="post">
            <div> {# Wrap in div for spacing #}
                <label for="reminder_date">Reminder Date and Time:</label>
                <input type="datetime-local" id="reminder_date" name="reminder_date" required>
            </div>

            <div> {# Wrap in div for spacing #}
                <label for="reminder_message">Reminder Message:</label>
                <textarea id="reminder_message" name="reminder_message" required></textarea>
            </div>

            <div class="button-group"> {# Using button-group class #}
                <button type="submit">
                    Set Reminder
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let currentCustomerRowId = null; // Use rowid

function openReminderModal(customerRowId) {
    currentCustomerRowId = customerRowId;
    const modal = document.getElementById('reminderModal');
    modal.style.display = 'flex'; // Use flex to center
    // Update the form action to use the rowid
    document.getElementById('reminderForm').action = `/set_reminder/${customerRowId}`;
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('reminderModal');
    if (event.target === modal) {
        modal.style.display = 'none';
    }
};

// Auto check reminders every 30 seconds
setInterval(function() {
    fetch('/check_reminders')
    .then(response => {
        if (!response.ok) {
            // Log the error or handle it appropriately
            console.error('Error checking reminders:', response.statusText);
            return []; // Return empty array to prevent further processing
        }
        return response.json();
    })
    .then(data => {
        data.forEach(reminder => {
            // Replace alert with a more user-friendly notification (e.g., a modal or toast)
            console.log(`üîî Reminder for ${reminder.customer_name}: ${reminder.reminder_message}`);
            // For demonstration, using alert:
            alert(`üîî Reminder for ${reminder.customer_name}: ${reminder.reminder_message}`);
            // Play a notification sound (if you have a sound file)
            // new Audio('/static/notification.mp3').play();
        });
    })
    .catch(error => console.error('Error fetching reminders:', error));
}, 30000); // Check every 30 seconds
</script>

</body>
</html>
